# A revolution is brewing
je_hre_impending_revolution = {

	icon = "gfx/interface/icons/event_icons/event_election.dds"
	
	group = je_group_internal_affairs

	scripted_button = je_1de_estate_button
	scripted_button = je_2de_estate_button
	scripted_button = je_3de_estate_button
	scripted_button = je_revolution_monarchy_actions_button
	#first estate buttons
	scripted_button = je_create_new_titles_to_appease_nobles_button
	#second estate buttons
	scripted_button = je_clamp_down_on_church_rights_button
	#thrird estate buttons
	scripted_button = je_appoint_bourgeois_ministers_button
	scripted_button = je_subsidize_food_distribution_button
	#monarchy buttons
	scripted_button = je_move_imperial_residence_button
	scripted_button = je_contruct_statue_of_monarch_button

	##Scripted progress bars
	scripted_progress_bar = br_hre_impending_revolution_progress_bar
	scripted_progress_bar = br_hre_impending_revolution_1de_estate_progress_bar
	scripted_progress_bar = br_hre_impending_revolution_2de_estate_progress_bar
	scripted_progress_bar = br_hre_impending_revolution_3de_estate_progress_bar

	is_shown_when_inactive = {
		and = {
			exists = c:HRE
			root = c:HRE
		}
	}

	possible = {
		and = {
			exists = c:HRE
			root = c:HRE
		}
	}

	immediate = {
		#make vanilla revolution imposible
		set_immune_to_revolutions = yes

		#create the political movements
		create_political_movement = {
			type = br_movement_anti_feudalism
		}
		create_political_movement = {
			type = br_movement_pro_feudalism
		}

		#set variables
		set_variable = {
			name = br_monarchy_popularity_var
			value = 0
		}

		#add revolution modifiers
		add_modifier = {
			name = br_modifier_unreliable_food_security
			months = -1
		}
		add_modifier = {
			name = br_modifier_unpopular_regime
			months = -1
		}
		add_modifier = {
			name = br_modifier_antiquated_regime
			months = -1
		}
		add_modifier = {
			name = br_modifier_special_chruch_rights
			months = -1
		}

		##Create the estates
		br_create_estates_for_revolution_scripted_effect = yes
		br_update_all_estate_disatisfaction_effect = yes

		##Set the Imperial Residence
		br_initialise_imperial_residence_effect = {
			original_residence_state_region = s:STATE_ILE_DE_FRANCE
			original_residence_building_type = br_building_palais_de_la_cite

			alternate_residence_state_region = s:STATE_ILE_DE_FRANCE
			alternate_residence_building_type = br_building_versailles
		}


		trigger_event = { 
			id = hre_revolution_events.1
			popup = yes
		}
		add_journal_entry = {
			type = je_revolution_reform
		}
		add_journal_entry = {
			type = je_revolution_suppress
		}
	}

	on_monthly_pulse = {
		effect = {
			br_update_all_estate_disatisfaction_effect = yes

			#Triggers for events
			if = {
				limit = {
					br_has_impending_revolution_pulse_event_cooldown = no
				}
				if = {
					limit = {
						any_scope_pop = {
							food_security <= br_impending_revolution_food_security_threshold
							percent >= br_impending_revolution_food_security_population_percentage_threshold
						}
						not = { has_variable = br_hre_impending_revolution_low_food_security_timeout_var }
					}
					trigger_event = {
						id = hre_revolution_events.5
						days = 10
						popup = yes
					}
				}
				else_if = {
					limit = {
						any_scope_state = {
							turmoil >=  br_impending_revolution_bandit_turmoil_threshold
							count >= br_impending_revolution_bandit_nr_states_threshold 
						}
						not = { has_variable = br_hre_impending_revolution_bandits_timeout_var }
					}
					trigger_event = {
						id = hre_revolution_events.6
						days = 10
						popup = yes
					}
				}
				else_if = {
					limit = {
						br_hre_has_specific_revolution_progress_scripted_trigger = {
							value = br_impending_revolution_militia_formation_revolution_progress_threshold
						}
						br_has_specific_3ste_estate_disatisfaction_scripted_trigger = {
							value = br_impending_revolution_militia_formation_3de_estate_disatisfaction_threshold
						}
						not = { has_variable = br_hre_impending_revolution_militias_form_timeout_var }
					}
					trigger_event = {
						id = hre_revolution_events.7
						days = 10
						popup = yes
					}
				}
				else_if = {
					limit = {
						has_variable = br_hre_impending_revolution_mititias_formed_var
						br_hre_has_specific_revolution_progress_scripted_trigger = {
							value = br_impending_revolution_arms_depots_raided_revolution_progress_threshold
						}
						br_has_specific_3ste_estate_disatisfaction_scripted_trigger = {
							value = br_impending_revolution_arms_depots_raided_3de_estate_disatisfaction_threshold
						}
						not = { has_variable = br_hre_impending_revolution_arms_depots_raided_timeout_var }
					}
					trigger_event = {
						id = hre_revolution_events.8
						days = 10
						popup = yes
					}
				}
			}

			#update monarchy popularity popularity 
			change_variable = {
				name = br_monarchy_popularity_var
				add = br_monarchy_popularity_change_value
			}
		}
	}

	custom_completion_header = br_je_hre_impending_revolution_completion_header

	complete = {
		custom_tooltip = {
			text = finished_revolution_tt
			has_variable = br_impending_revolution_complete_var
		}
	}

	on_complete = {
		# trigger_event = {
		# 	id = hre_revolution_events.2
		# 	popup = yes
		# }

		# hidden_effect = {
		# 	set_variable = br_impending_revolution_complete_var
		# }
		add_journal_entry = {
			type = je_national_identity
		}
	}

	custom_failure_header = br_je_hre_impending_revolution_failure_header

	fail = {
		OR = {
			# has_law = law_type:law_presidential_republic
			NOT = {
				has_law = law_type:law_monarchy
			}
			custom_tooltip = {
				text = if_journal_timeout_tt
				has_variable = br_revolution_timeout_var #var that does not exit so that the condition is not checked
			}

			#The revolution progress has reached 100%
			br_hre_has_max_revolution_progress_scripted_trigger = yes
		}
	}
	
	# custom_on_failure_header = br_je_hre_impending_revolution_on_failure_header

	on_fail = {
		br_one_of_the_estates_begins_launching_a_revolution_scripted_effect = yes
	}

	timeout = 18250  #50 years

	#on_timeout the revolution happens
	on_timeout = {
		br_one_of_the_estates_begins_launching_a_revolution_scripted_effect = yes
	}

	weight = 10000

	should_be_pinned_by_default = yes
}

# reform the state
je_revolution_reform = {

	group = je_group_internal_affairs

	icon = "gfx/interface/icons/event_icons/event_military.dds"

	scripted_button = je_revoke_noble_priviliges_button
	scripted_button = je_begin_modernizing_the_regime_button

	on_monthly_pulse = {
		effect = {
			#trigger an event to stabalise our food security
			if = {
				limit = {
					has_modifier = br_modifier_unreliable_food_security
					any_scope_pop = {
						food_security >= br_impending_revolution_food_security_stablity_threshold
						percent >= br_impending_revolution_min_food_security_population_percentage_threshold_for_stable_food_supply
					}
				}
				trigger_event = {
					id = hre_revolution_events.501
					popup = yes
				}
			}
			#trigger an event that indicates that the government is popular right now
			if = {
				limit = {
					has_modifier = br_modifier_unpopular_regime
					br_has_monarchy_popularity_reached_given_value_trigger = {
						value = br_impending_revolution_monarchy_popularity_threshold_for_popular_regime
					}
				}
				trigger_event = {
					id = hre_revolution_events.502
					popup = yes
				}
			}
		}
	}

	complete = {
		NOT = {
			has_law = law_type:law_autocracy
			has_law = law_type:law_oligarchy
			has_law = law_type:law_landed_voting
			has_law = law_type:law_hereditary_bureaucrats
			has_law = law_type:law_serfdom
			has_law = law_type:law_traditionalism
			has_law = law_type:br_law_feudalism_enforced
			has_law = law_type:br_law_feudalism_codified
			has_modifier = br_modifier_noble_privileges
			has_modifier = br_modifier_unreliable_food_security
			has_modifier = br_modifier_antiquated_regime
			has_modifier = br_modifier_unpopular_regime
			# has_modifier = br_modifier_feudalism
		}
	}

	on_complete = {
		trigger_event = {
			id = hre_revolution_events.3
			popup = no
		}
		add_modifier = {
			name = br_modifier_peoples_monarchy
			years = -1
		}
		#remove_modifier = br_modifier_noble_privileges
	}

	invalid = {
		custom_tooltip = {
			text = finished_revolution_tt
			has_variable = br_impending_revolution_complete_var
		}
	}

	weight = 8000

	#should_be_pinned_by_default = yes
}

# Suppress the revolution
je_revolution_suppress = {

	group = je_group_internal_affairs

	icon = "gfx/interface/icons/event_icons/event_military.dds"

	complete = {
		has_law = law_type:law_autocracy
		has_law = law_type:law_censorship
		OR = {
			has_law = law_type:law_national_guard
			has_law = law_type:law_professional_army
		}
		NOT = {
			has_law = law_type:law_peasant_levies
		}
		OR = {
			has_law = law_type:br_law_feudalism_enforced
			has_law = law_type:br_law_feudalism_codified
		}
		ig:ig_landowners = {
			is_powerful = yes
			is_in_government = yes
		}
		ig:ig_armed_forces = {
			is_powerful = yes
			is_in_government = yes
		}
	}

	on_complete = {
		trigger_event = {
			id = hre_revolution_events.4
			popup = no
		}
		add_modifier = {
			name = br_modifier_heir_of_augustus
			years = -1
		}
		#remove_modifier = br_modifier_noble_privileges
	}

	invalid = {
		custom_tooltip = {
			text = finished_revolution_tt
			has_variable = br_impending_revolution_complete_var
		}
	}

	weight = 8000

	#should_be_pinned_by_default = yes
}

# The actual revolution
# je_hre_revolution = {

# 	group = je_group_internal_affairs

# 	icon = "gfx/interface/icons/event_icons/event_military.dds"

# 	scripted_progress_bar = br_hre_revolution_progress_bar

# 	is_shown_when_inactive = {
# 		c:HRE = this
# 	}

# 	possible = {
# 		c:HRE = this
# 	}

# 	complete = {

# 	}

# 	on_complete = {
# 		trigger_event = {
# 			id = hre_revolution_events.4
# 			popup = no
# 		}
# 		add_modifier = {
# 			name = br_modifier_heir_of_augustus
# 			years = -1
# 		}
# 		#remove_modifier = br_modifier_noble_privileges
# 	}

# 	invalid = {
# 		custom_tooltip = {
# 			text = finished_revolution_tt
# 			has_variable = br_impending_revolution_complete_var
# 		}
# 	}

# 	weight = 8000

# 	should_be_pinned_by_default = yes
# }